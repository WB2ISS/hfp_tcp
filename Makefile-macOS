####    Makefile-macOS
###
###
#
#	cd <xxxxx>/hfp_tcp
# rm -rf build
# mkdir build
# cd build
# make -f ../Makefile-macOS [hfp_tcp|dmg|pkg|all|clean]

EXECUTABLE 					= hfp_tcp
VERSION     				= 1.2.126
MACOS								= macos12
PROFILE     				= "SDR"

SRCDIR 							= ..
SOURCE 							= $(SRCDIR)/hfp_tcp.c
LICENSE         		= $(SRCDIR)/$(EXECUTABLE)-license.rtf
DISTRIBUTION    		= $(SRCDIR)/distribution.xml
INSTALL         		= /usr/local/bin

AIRSPYSOURCE 				= $(LIBAIRSPYHFSRC)/airspyhf.c $(LIBAIRSPYHFSRC)/iqbalancer.c
LIBAIRSPYHFSRC			= ../../airspyhf/libairspyhf/src
LIBAIRSPYHFINCLUDE	= ../../airspyhf/libairspyhf/src

LIBUSBSTATICDIRx86  = ../../libusb-1.0.26/build-static-x86_64-macos12
LIBUSBSTATICDIRARM  = ../../libusb-1.0.26/build-static-arm64-macos12
LIBUSBINCLUDE				= ../../libusb-1.0.26/libusb

LIBx86      				= $(LIBUSBSTATICDIRx86)/libusb-1.0.a \
										  $(LIBUSBSTATICDIRx86)/darwin_usb.o

LIBARM      				= $(LIBUSBSTATICDIRARM)/libusb-1.0.a \
							        $(LIBUSBSTATICDIRARM)/darwin_usb.o

SIGNID							= "Developer ID Application: Transition Technology Ventures, LLC (6V82P5ET42)"
INSTALLID						= "Developer ID Installer: Transition Technology Ventures, LLC (6V82P5ET42)"

FOLDER 							= $(EXECUTABLE)-$(VERSION)-$(MACOS)
DMG									= $(FOLDER).dmg
PKG									= $(FOLDER).pkg
PKGL            		= $(FOLDER)-L.pkg



hfp_tcp:			$(SOURCE)

								clang $(SOURCE) $(AIRSPYSOURCE) $(LIBx86) \
								    -framework Foundation  \
							      -framework IOKit  \
										-framework Security \
										-I. \
										-I$(LIBAIRSPYHFINCLUDE) \
										-I$(LIBUSBINCLUDE) \
										-L/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk/usr/include \
										-lm \
										-target x86_64-apple-$(MACOS) -o $(EXECUTABLE)-x86_64

								clang $(SOURCE) $(AIRSPYSOURCE) $(LIBARM) \
										 -framework Foundation  \
										 -framework IOKit  \
										 -framework Security \
										 -I. \
										 -I$(LIBAIRSPYHFINCLUDE) \
										 -I$(LIBUSBINCLUDE) \
										 -L/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk/usr/include \
										 -lm \
										 -target arm64-apple-$(MACOS)  -o $(EXECUTABLE)-arm64

								lipo -create -output $(EXECUTABLE) $(EXECUTABLE)-x86_64 $(EXECUTABLE)-arm64
								lipo -archs $(EXECUTABLE)
								otool -L $(EXECUTABLE)


dmg:						$(EXECUTABLE)

								 mkdir $(FOLDER)-dmg
								 cp $(EXECUTABLE) $(FOLDER)-dmg
								 cp $(LICENSE) $(FOLDER)-dmg
								 codesign -vf --timestamp --options runtime --sign $(SIGNID) $(FOLDER)-dmg/$(EXECUTABLE)
								 hdiutil create -fs HFS+ -srcfolder $(FOLDER)-dmg -volname $(FOLDER)-dmg $(DMG)
								 codesign -vf --timestamp --options runtime --sign $(SIGNID) $(DMG)
								 codesign --verify --verbose $(DMG)
								 xcrun notarytool submit $(DMG) --keychain-profile $(PROFILE) --wait
								 spctl -a -t open --context context:primary-signature -v $(DMG)
								 xcrun stapler staple $(DMG)
								 xcrun stapler validate $(DMG)


pkg:						$(EXECUTABLE)

								 mkdir $(FOLDER)-pkg
								 cp $(EXECUTABLE)	$(FOLDER)-pkg
								 codesign -vf --timestamp --options runtime --sign $(SIGNID) $(FOLDER)-pkg/$(EXECUTABLE)
								 pkgbuild --root ./$(FOLDER)-pkg \
								 					--identifier $(EXECUTABLE) \
								 					--install-location $(INSTALL) \
								 					--sign $(INSTALLID) \
													$(PKGL)

								productbuild --package-path $(PKGL) \
													--sign $(INSTALLID) \
													--distribution $(DISTRIBUTION) \
													--resources $(SRCDIR) \
													$(PKG)

								pkgutil --check-signature $(PKG)
								xcrun notarytool submit $(PKG) --keychain-profile $(PROFILE) --wait
								xcrun stapler staple $(PKG)
								xcrun stapler validate $(PKG)
								spctl --assess --verbose --type install $(PKG)

all:					$(EXECUTABLE) dmg pkg


clean:

								rm -rf $(EXECUTABLE) $(EXECUTABLE)-x86_64 $(EXECUTABLE)-arm64 $(FOLDER)-dmg $(DMG) $(FOLDER)-pkg $(PKGL) $(PKG)
